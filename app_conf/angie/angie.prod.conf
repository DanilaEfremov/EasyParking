load_module modules/ngx_http_brotli_static_module.so;
load_module modules/ngx_http_brotli_filter_module.so;


events {
    # конфигурация обработки соединений
}

http {
    upstream minio_s3 {
        least_conn;
        server minio:9000;
    }

    upstream minio_console {
        least_conn;
        server minio:9001;
    }

    server {
        listen 80;
        http2 on;
        server_name localhost;
        include /etc/angie/mime.types;

        location / {
            proxy_pass http://web:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
#             add_header Access-Control-Allow-Origin http://localhost;
        }

        location /favicon.ico {
            alias /usr/share/angie/static/favicon/favicon.ico;
        }

        location /assets/ {
            alias /usr/share/angie/static/;
        }

        location ~ ^/flower/? {

            auth_basic "Flower Login";
            auth_basic_user_file /etc/angie/.htpasswd;

            sub_filter_last_modified on;
            sub_filter_once off;

            proxy_pass http://flower:5555;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Protocol $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
        }

        location /minio/ui/ {
            rewrite ^/minio/ui/(.*) /$1 break;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-NginX-Proxy true;

            # This is necessary to pass the correct IP to be hashed
            real_ip_header X-Real-IP;

            proxy_connect_timeout 300;

            # To support websockets in MinIO versions released after January 2023
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            # Some environments may encounter CORS errors (Kubernetes + Nginx Ingress)
            # Uncomment the following line to set the Origin request to an empty string
            # proxy_set_header Origin '';

            chunked_transfer_encoding off;

            proxy_pass http://minio_console; # This uses the upstream directive definition to load balance
        }

         location /minio/s3/ {
            rewrite ^/minio/s3/(.*) /$1 break;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 300;
            # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;

            proxy_pass http://minio_s3; # This uses the upstream directive definition to load balance

#              # Allow special characters in headers
#             ignore_invalid_headers off;
#           # Allow any size file to be uploaded.
            # Set to a value such as 1000m; to restrict file size to a specific value
            client_max_body_size 0;
            # Disable buffering
            proxy_buffering off;
            proxy_request_buffering off;
        }

        # PGAdmin
        location /pgadmin/ {
            proxy_set_header X-Script-Name /pgadmin;
            proxy_set_header Host $host;
            proxy_pass http://pgadmin:80/;
            proxy_redirect off;
        }



        location /rabbitmq/ {
            rewrite ^/rabbitmq/(.*) /$1 break;
            proxy_pass http://rabbitmq:15672;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-NginX-Proxy true;
        }


        location /console/ {

            # Только локальный доступ
#             allow 127.0.0.1;
#             deny all;

            auto_redirect on;

            alias /usr/share/angie-console-light/html/;
            # Только во FreeBSD:
            # alias /usr/local/www/angie-console-light/html/;
            index index.html;

            location /console/api/ {
                api /status/;
            }

            # Чтобы после аутентификации работали функции редактирования (только PRO)
#             location /console/api/config/ {
#
#                 auth_basic           "Защищенный сайт";
#                 auth_basic_user_file conf/htpasswd;
#
#                 api /config/;
#             }
        }


        error_log  /var/log/angie/error.log;
        access_log /var/log/angie/access.log;
    }

#     server {
#         listen       8080;
#         # listen  [::]:8080;
#         http2 on;
#         server_name  localhost;
#
#         # Allow special characters in headers
#         ignore_invalid_headers off;
#         # Allow any size file to be uploaded.
#         # Set to a value such as 1000m; to restrict file size to a specific value
#         client_max_body_size 0;
#         # Disable buffering
#         proxy_buffering off;
#         proxy_request_buffering off;
#
#         location / {
#             proxy_set_header Host $http_host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#
#             proxy_connect_timeout 300;
#             # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
#             proxy_http_version 1.1;
#             proxy_set_header Connection "";
#             chunked_transfer_encoding off;
#
#             proxy_pass http://minio_s3; # This uses the upstream directive definition to load balance
#         }
#
#         error_log  /var/log/angie/error1.log;
#         access_log /var/log/angie/access1.log;
#     }

}